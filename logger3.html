<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Roast Logger</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:10px;
}
button{
  padding:12px;
  margin:6px;
  font-size:16px;
  touch-action:manipulation;
}
input{font-size:18px;}
canvas{margin-top:20px;}
#phaseInfo{font-size:18px;line-height:1.6;margin-top:10px}
</style>
</head>

<body>

<h2>☕ Roast Logger（完成版）</h2>

<p>豆名 <input id="beanName"></p>
<p>バッチ重量(g) <input id="batchWeight" type="number"></p>

<button id="startBtn">焙煎スタート</button>

<h2 id="timer">0:00</h2>

<h3>温度</h3>
<button onclick="tempDown()">−</button>
<input id="tempInput" type="number" style="width:80px;text-align:center">
<button onclick="tempUp()">＋</button>
<button onclick="addTemp()">追加</button>

<h3>ガス</h3>
<button onclick="gasDown()">−</button>
<span id="gasDisplay">0.0</span>
<button onclick="gasUp()">＋</button>
<button onclick="recordGas()">記録</button>

<h3>フェーズ</h3>
<button ontouchstart="startHold('dry')" ontouchend="cancelHold()">Dry End（長押し）</button>
<button ontouchstart="startHold('fc')" ontouchend="cancelHold()">1ハゼ（長押し）</button>
<button onclick="setDrop()">Drop</button>

<canvas id="chart"></canvas>

<h3>フェーズ内訳</h3>
<div id="phaseInfo">Dry / 1ハゼ / Drop を指定してください</div>

<button onclick="exportCSV()">CSV書き出し</button>

<script>
/* ===== 状態 ===== */
let times=[],temps=[],gasLog=[];
let roastStart=null,timerInt=null;
let dryEndTime=null,firstCrackTime=null,dropTime=null;
let currentTemp=0,currentGas=0;
let chargeTemp=null,chargeGas=null;

/* ===== utils ===== */
function formatTime(s){
  return Math.floor(s/60)+":"+String(s%60).padStart(2,"0");
}
function sec(){
  return Math.floor((Date.now()-roastStart)/1000);
}

/* ===== タイマー ===== */
document.getElementById("startBtn").onclick=()=>{
  clearInterval(timerInt);
  roastStart=Date.now();

  times=[0];
  temps=[currentTemp];
  gasLog=[{time:0,gas:currentGas}];

  chargeTemp=currentTemp;
  chargeGas=currentGas;

  dryEndTime=firstCrackTime=dropTime=null;
  phaseInfo.textContent="Dry / 1ハゼ / Drop を指定してください";

  timer.textContent="0:00";
  timerInt=setInterval(()=>timer.textContent=formatTime(sec()),1000);

  drawChart();
};

/* ===== 温度 ===== */
function tempUp(){currentTemp++;tempInput.value=currentTemp;}
function tempDown(){currentTemp--;tempInput.value=currentTemp;}
tempInput.onchange=()=>currentTemp=Number(tempInput.value);

function addTemp(){
  times.push(sec());
  temps.push(currentTemp);
  drawChart();
}

/* ===== ガス ===== */
function gasUp(){
  currentGas=(currentGas+0.1).toFixed(1)*1;
  gasDisplay.textContent=currentGas.toFixed(1);
}
function gasDown(){
  currentGas=Math.max(0,(currentGas-0.1).toFixed(1)*1);
  gasDisplay.textContent=currentGas.toFixed(1);
}
function recordGas(){
  gasLog.push({time:sec(),gas:currentGas});
  drawChart();
}

/* ===== フェーズ ===== */
let holdTimer=null;
function startHold(t){
  holdTimer=setTimeout(()=>{
    if(t==="dry") dryEndTime=sec();
    if(t==="fc") firstCrackTime=sec();
    drawChart();
  },1500);
}
function cancelHold(){clearTimeout(holdTimer);}
function setDrop(){
  dropTime=sec();
  clearInterval(timerInt);
  drawChart();
  updatePhaseInfo();
}

/* ===== フェーズ時間・％ ===== */
function updatePhaseInfo(){
  if(!dryEndTime || !firstCrackTime || !dropTime) return;

  const dry=dryEndTime;
  const maillard=firstCrackTime-dryEndTime;
  const dev=dropTime-firstCrackTime;
  const total=dropTime;

  function pct(t){return Math.round((t/total)*100);}

  phaseInfo.innerHTML=`
    Dry : ${formatTime(dry)} (${pct(dry)}%)<br>
    Maillard : ${formatTime(maillard)} (${pct(maillard)}%)<br>
    Development : ${formatTime(dev)} (${pct(dev)}%)
  `;
}

/* ===== RoR ===== */
function RoR(){
  let r=[null];
  for(let i=1;i<temps.length;i++){
    r.push((temps[i]-temps[i-1])/((times[i]-times[i-1])/60));
  }
  return r;
}
function gasSeries(){
  let r=[],g=null,i=0;
  times.forEach(t=>{
    while(i<gasLog.length && gasLog[i].time<=t){
      g=gasLog[i].gas;i++;
    }
    r.push(g);
  });
  return r;
}

/* ===== 背景＆Charge ===== */
const phaseBg={
  id:"phaseBg",
  beforeDraw(chart){
    const {ctx,chartArea,scales}=chart;
    if(!chartArea) return;
    const x=scales.x;
    const h=chartArea.bottom-chartArea.top;

    function fill(a,b,c){
      ctx.fillStyle=c;
      ctx.fillRect(
        x.getPixelForValue(a),
        chartArea.top,
        x.getPixelForValue(b)-x.getPixelForValue(a),
        h
      );
    }
    if(dryEndTime) fill(0,dryEndTime,"rgba(255,200,200,.2)");
    if(firstCrackTime) fill(dryEndTime,firstCrackTime,"rgba(255,230,150,.2)");
    if(dropTime) fill(firstCrackTime,dropTime,"rgba(200,255,200,.2)");
  }
};

const chargeLine={
  id:"charge",
  afterDraw(chart){
    const {ctx,chartArea,scales}=chart;
    const x=scales.x.getPixelForValue(0);
    ctx.strokeStyle="black";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(x,chartArea.top);
    ctx.lineTo(x,chartArea.bottom);
    ctx.stroke();
    ctx.fillText("Charge",x+4,chartArea.top+12);
  }
};

/* ===== グラフ ===== */
const chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{labels:[],datasets:[]},
  options:{
    scales:{
      x:{
        type:"linear",
        min:0,
        max:600,                 // ★ 10分先まで先に表示
        ticks:{
          stepSize:60,
          callback:v=>formatTime(v)
        },
        title:{display:true,text:"Time"}
      },
      tempAxis:{
        type:"linear",
        position:"left",
        ticks:{stepSize:5},
        title:{display:true,text:"Temp ℃"}
      },
      rorAxis:{
        type:"linear",
        position:"right",
        ticks:{stepSize:1},
        grid:{drawOnChartArea:false},
        title:{display:true,text:"RoR"}
      },
      gasAxis:{
        type:"linear",
        position:"right",
        grid:{drawOnChartArea:false},
        min:0,
        title:{display:true,text:"Gas"}
      }
    }
  },
  plugins:[phaseBg,chargeLine]
});

function drawChart(){
  // ★ 10分 or 現在時刻まで自動拡張
  chart.options.scales.x.max =
    Math.max(600, dropTime || times[times.length-1] || 0);

  chart.data.labels=times;
  chart.data.datasets=[
    {
      label:"Temp",
      data:temps,
      yAxisID:"tempAxis",
      tension:0.3,
      pointRadius:i=>i.dataIndex===0?6:2,
      pointBackgroundColor:i=>i.dataIndex===0?"red":"#ff6b6b"
    },
    {
      label:"RoR",
      data:RoR(),
      yAxisID:"rorAxis"
    },
    {
      label:"Gas",
      data:gasSeries(),
      yAxisID:"gasAxis",
      stepped:true
    }
  ];
  chart.update();
}

/* ===== CSV ===== */
function exportCSV(){
  const rows=[["Bean","ChargeTemp","ChargeGas","Time(s)","Temp","RoR","Gas"].join(",")];
  const ror=RoR(),gas=gasSeries();
  times.forEach((t,i)=>{
    rows.push([
      beanName.value,
      chargeTemp,
      chargeGas,
      t,
      temps[i],
      ror[i]?.toFixed(2)||"",
      gas[i]??""
    ].join(","));
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="roast.csv";
  a.click();
}
</script>

</body>
</html>