<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Roast Logger</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:10px;
  touch-action:manipulation;
  -webkit-user-select:none;
  user-select:none;
}
button{
  padding:12px;
  margin:6px;
  font-size:16px;
}
input{font-size:20px;}
#timer{
  font-size:34px;
  text-align:center;
  margin:10px 0;
}
h3{margin-top:20px;}
</style>
</head>

<body>

<h2>☕ Roast Logger（完成版）</h2>

<div style="text-align:center">
  <button id="startBtn">焙煎スタート</button>
</div>

<div id="timer">00:00</div>

<h3>温度</h3>
<div style="text-align:center">
  <button onclick="safeTap(tempDown)">−</button>
  <input id="tempInput" type="number" value="0"
         style="width:90px;text-align:center">℃
  <button onclick="safeTap(tempUp)">＋</button><br><br>
  <button onclick="safeTap(addTemp)">温度追加</button>
</div>

<h3>ガス圧</h3>
<div style="text-align:center">
  <button onclick="safeTap(gasDown)">−</button>
  <span id="gasDisplay" style="font-size:24px;margin:0 15px">0.0</span>
  <button onclick="safeTap(gasUp)">＋</button><br>
  <button onclick="safeTap(recordGas)">ガス圧記録</button>
</div>

<h3>フェーズ</h3>
<div style="text-align:center">
  <button ontouchstart="startHold('dry')" ontouchend="cancelHold()">Dry End（長押し）</button>
  <button ontouchstart="startHold('fc')" ontouchend="cancelHold()">1ハゼ（長押し）</button>
  <button onclick="safeTap(setDrop)">Drop</button>
</div>

<h3>フェーズ時間</h3>
<div id="phaseInfo"></div>

<canvas id="chart" height="260"></canvas>

<div style="text-align:center">
  <button onclick="exportCSV()">CSV書き出し</button>
</div>

<script>
/* ===== タップ保護 ===== */
let lastTap=0;
function safeTap(fn){
  const n=Date.now();
  if(n-lastTap<350)return;
  lastTap=n; fn();
}

/* ===== 状態 ===== */
let times=[],temps=[],gasLog=[];
let startTime=null,timerInt=null;
let currentTemp=0,currentGas=0;
let dryEndTime=null,firstCrackTime=null,dropTime=null;
let chargeTemp=null,chargeGas=null;
let chart;

/* ===== DOM ===== */
const timer=document.getElementById("timer");
const tempInput=document.getElementById("tempInput");
const gasDisplay=document.getElementById("gasDisplay");

/* ===== タイマー ===== */
document.getElementById("startBtn").addEventListener("click",()=>{
  clearInterval(timerInt);

  times=[0];
  temps=[Number(tempInput.value)||0];
  gasLog=[{time:0,gas:currentGas}];

  chargeTemp=temps[0];
  chargeGas=currentGas;

  dryEndTime=firstCrackTime=dropTime=null;

  startTime=Date.now();
  timerInt=setInterval(updateTimer,1000);

  drawChart();
});

function updateTimer(){
  timer.textContent=formatTime(sec());
  updatePhaseInfo();
}

/* ===== 温度 ===== */
function tempUp(){currentTemp++;tempInput.value=currentTemp;}
function tempDown(){currentTemp--;tempInput.value=currentTemp;}
function addTemp(){
  times.push(sec());
  temps.push(currentTemp);
  drawChart();
}

/* ===== ガス ===== */
function gasUp(){
  currentGas=Math.round((currentGas+0.1)*10)/10;
  gasDisplay.textContent=currentGas.toFixed(1);
}
function gasDown(){
  currentGas=Math.max(0,Math.round((currentGas-0.1)*10)/10);
  gasDisplay.textContent=currentGas.toFixed(1);
}
function recordGas(){
  gasLog.push({time:sec(),gas:currentGas});
  drawChart();
}

/* ===== フェーズ ===== */
let holdTimer=null;
function startHold(t){
  holdTimer=setTimeout(()=>{
    if(t==='dry') dryEndTime=sec();
    if(t==='fc') firstCrackTime=sec();
    drawChart(); updatePhaseInfo();
    navigator.vibrate?.(100);
  },1500);
}
function cancelHold(){clearTimeout(holdTimer);}
function setDrop(){
  dropTime=sec();
  clearInterval(timerInt);
  drawChart(); updatePhaseInfo();
}

/* ===== フェーズ時間 ===== */
function updatePhaseInfo(){
  const el=document.getElementById("phaseInfo");
  if(!dryEndTime||!firstCrackTime){el.textContent="フェーズ未確定";return;}
  const total=(dropTime??sec());
  const dry=dryEndTime;
  const mail=firstCrackTime-dryEndTime;
  const dev=total-firstCrackTime;
  const pct=s=>(s/total*100).toFixed(1);
  el.innerHTML=
    `Dry：${formatTime(dry)}（${pct(dry)}％）<br>`+
    `Maillard：${formatTime(mail)}（${pct(mail)}％）<br>`+
    `Development：${formatTime(dev)}（${pct(dev)}％）<br><hr>`+
    `合計：${formatTime(total)}`;
}

/* ===== 時間表示 ===== */
function formatTime(s){
  return Math.floor(s/60)+":"+String(s%60).padStart(2,"0");
}

/* ===== フェーズ背景 ===== */
const phaseBackgroundPlugin={
  id:'phaseBackground',
  beforeDraw(chart){
    const {ctx,chartArea,scales}=chart;
    if(!chartArea)return;
    const x=scales.x;
    const top=chartArea.top,bottom=chartArea.bottom;

    function draw(start,end,color){
      if(start==null||end==null)return;
      const xs=x.getPixelForValue(formatTime(start));
      const xe=x.getPixelForValue(formatTime(end));
      ctx.save();
      ctx.fillStyle=color;
      ctx.fillRect(xs,top,xe-xs,bottom-top);
      ctx.restore();
    }
    draw(0,dryEndTime,'rgba(255,235,150,0.25)');
    draw(dryEndTime,firstCrackTime,'rgba(255,200,120,0.25)');
    draw(firstCrackTime,dropTime??sec(),'rgba(255,150,150,0.25)');
  }
};

/* ===== Chargeマーカー ===== */
const chargeMarkerPlugin={
  id:'chargeMarker',
  afterDraw(chart){
    const {ctx,chartArea,scales}=chart;
    if(!chartArea)return;
    const x=scales.x.getPixelForValue(formatTime(0));
    ctx.save();
    ctx.strokeStyle='rgba(0,0,0,0.6)';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(x,chartArea.top);
    ctx.lineTo(x,chartArea.bottom);
    ctx.stroke();
    ctx.fillStyle='rgba(0,0,0,0.8)';
    ctx.font='bold 12px sans-serif';
    ctx.fillText('Charge',x+4,chartArea.top+14);
    ctx.restore();
  }
};

/* ===== グラフ ===== */
function initChart(){
  chart=new Chart(document.getElementById("chart"),{
    type:"line",
    plugins:[phaseBackgroundPlugin,chargeMarkerPlugin],
    data:{labels:[],datasets:[]},
    options:{
      animation:false,
      scales:{
        x:{title:{display:true,text:"Time"}},
        tempAxis:{position:"left",ticks:{stepSize:5},title:{display:true,text:"Temp"}},
        rorAxis:{position:"right",ticks:{stepSize:1},grid:{drawOnChartArea:false},title:{display:true,text:"RoR"}},
        gasAxis:{position:"right",grid:{drawOnChartArea:false},title:{display:true,text:"Gas"}}
      }
    }
  });
}

function RoR(){
  let r=[null];
  for(let i=1;i<temps.length;i++)
    r.push((temps[i]-temps[i-1])/((times[i]-times[i-1])/60));
  return r;
}
function gasSeries(){
  let r=[],g=null,i=0;
  times.forEach(t=>{
    while(i<gasLog.length&&gasLog[i].time<=t){g=gasLog[i].gas;i++;}
    r.push(g);
  });
  return r;
}
function drawChart(){
  chart.data.labels=times.map(t=>formatTime(t));
  chart.data.datasets=[
    {
      label:"Temp",
      data:temps,
      yAxisID:"tempAxis",
      pointRadius:ctx=>ctx.dataIndex===0?6:2,
      pointBackgroundColor:ctx=>ctx.dataIndex===0?"red":undefined
    },
    {label:"RoR",data:RoR(),yAxisID:"rorAxis"},
    {
      label:"Gas",
      data:gasSeries(),
      yAxisID:"gasAxis",
      stepped:true,
      pointRadius:ctx=>ctx.dataIndex===0?6:0,
      pointBackgroundColor:ctx=>ctx.dataIndex===0?"blue":undefined
    }
  ];
  chart.update();
}

/* ===== CSV出力 ===== */
function exportCSV(){
  if(times.length===0)return;
  const rows=[];
  const date=new Date().toLocaleDateString();
  rows.push("Date,ChargeTemp,ChargeGas,Time(s),Temp,RoR,Gas,Phase");

  const ror=RoR();
  const gas=gasSeries();

  times.forEach((t,i)=>{
    let phase="Dry";
    if(t===0) phase="Charge";
    else if(firstCrackTime&&t>=firstCrackTime) phase="Development";
    else if(dryEndTime&&t>=dryEndTime) phase="Maillard";

    rows.push([
      date,
      chargeTemp,
      chargeGas,
      t,
      temps[i],
      ror[i]!=null?ror[i].toFixed(2):"",
      gas[i]??"",
      phase
    ].join(","));
  });

  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`roast_${date}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ===== util ===== */
function sec(){return Math.floor((Date.now()-startTime)/1000);}

/* ===== init ===== */
initChart();
</script>

</body>
</html>