<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Roast Logger</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:10px;
  touch-action:manipulation;
  -webkit-user-select:none;
  user-select:none;
}
button{
  padding:12px;
  margin:6px;
  font-size:16px;
}
input{font-size:20px;}
#timer{font-size:34px;text-align:center;margin:10px 0;}
h3{margin-top:20px;}
</style>
</head>

<body>

<h2>☕ Roast Logger（完成版）</h2>

<div style="text-align:center">
  <button id="startBtn">焙煎スタート</button>
</div>
<div id="timer">00:00</div>

<h3>温度</h3>
<div style="text-align:center">
  <button onclick="safeTap(tempDown)">−</button>
  <input id="tempInput" type="number" value="0"
         style="width:90px;text-align:center">℃
  <button onclick="safeTap(tempUp)">＋</button><br><br>
  <button onclick="safeTap(addTemp)">温度追加</button>
</div>

<h3>ガス圧</h3>
<div style="text-align:center">
  <button onclick="safeTap(gasDown)">−</button>
  <span id="gasDisplay" style="font-size:24px;margin:0 15px">0.0</span>
  <button onclick="safeTap(gasUp)">＋</button><br>
  <button onclick="safeTap(recordGas)">ガス圧記録</button>
</div>

<h3>フェーズ</h3>
<div style="text-align:center">
  <button ontouchstart="startHold('dry')" ontouchend="cancelHold()">Dry End（長押し）</button>
  <button ontouchstart="startHold('fc')" ontouchend="cancelHold()">1ハゼ（長押し）</button>
  <button onclick="safeTap(setDrop)">Drop</button>
</div>

<h3>フェーズ時間</h3>
<div id="phaseInfo"></div>

<canvas id="chart" height="260"></canvas>

<script>
/* ===== タップ保護 ===== */
let lastTap=0;
function safeTap(fn){
  const n=Date.now();
  if(n-lastTap<350)return;
  lastTap=n; fn();
}

/* ===== 状態 ===== */
let times=[],temps=[],gasLog=[];
let startTime=null,timerInt=null;
let currentTemp=0,currentGas=0;
let dryEndTime=null,firstCrackTime=null,dropTime=null;
let chart;

/* ===== DOM ===== */
const timer=document.getElementById("timer");
const tempInput=document.getElementById("tempInput");
const gasDisplay=document.getElementById("gasDisplay");

/* ===== タイマー ===== */
document.getElementById("startBtn").addEventListener("click",()=>{
  clearInterval(timerInt);
  times=[]; temps=[]; gasLog=[];
  dryEndTime=firstCrackTime=dropTime=null;
  startTime=Date.now();
  timerInt=setInterval(updateTimer,1000);
});

function updateTimer(){
  const s=sec();
  timer.textContent=Math.floor(s/60)+":"+String(s%60).padStart(2,"0");
  updatePhaseInfo();
}

/* ===== 温度 ===== */
function tempUp(){currentTemp++;tempInput.value=currentTemp;}
function tempDown(){currentTemp--;tempInput.value=currentTemp;}
function addTemp(){
  times.push(sec());
  temps.push(currentTemp);
  drawChart();
}

/* ===== ガス ===== */
function gasUp(){
  currentGas=Math.round((currentGas+0.1)*10)/10;
  gasDisplay.textContent=currentGas.toFixed(1);
}
function gasDown(){
  currentGas=Math.max(0,Math.round((currentGas-0.1)*10)/10);
  gasDisplay.textContent=currentGas.toFixed(1);
}
function recordGas(){
  gasLog.push({time:sec(),gas:currentGas});
  drawChart();
}

/* ===== フェーズ ===== */
let holdTimer=null;
function startHold(t){
  holdTimer=setTimeout(()=>{
    if(t==='dry') dryEndTime=sec();
    if(t==='fc') firstCrackTime=sec();
    drawChart(); updatePhaseInfo();
    navigator.vibrate?.(100);
  },1500);
}
function cancelHold(){clearTimeout(holdTimer);}
function setDrop(){
  dropTime=sec();
  clearInterval(timerInt);
  drawChart(); updatePhaseInfo();
}

/* ===== フェーズ表示 ===== */
function updatePhaseInfo(){
  const el=document.getElementById("phaseInfo");
  if(!dryEndTime||!firstCrackTime){el.textContent="フェーズ未確定";return;}
  const total=(dropTime??sec());
  const dry=dryEndTime;
  const mail=firstCrackTime-dryEndTime;
  const dev=total-firstCrackTime;
  const fmt=s=>Math.floor(s/60)+":"+String(s%60).padStart(2,"0");
  const pct=s=>(s/total*100).toFixed(1);
  el.innerHTML=
    `Dry：${fmt(dry)}（${pct(dry)}％）<br>`+
    `Maillard：${fmt(mail)}（${pct(mail)}％）<br>`+
    `Development：${fmt(dev)}（${pct(dev)}％）<br><hr>`+
    `合計：${fmt(total)}`;
}

/* ===== グラフ ===== */
function initChart(){
  chart=new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels:[],datasets:[]},
    options:{
      animation:false,
      scales:{
        tempAxis:{position:"left",ticks:{stepSize:5},title:{display:true,text:"Temp"}},
        rorAxis:{position:"right",ticks:{stepSize:1},grid:{drawOnChartArea:false},title:{display:true,text:"RoR"}},
        gasAxis:{position:"right",grid:{drawOnChartArea:false},title:{display:true,text:"Gas"}}
      }
    }
  });
}
function RoR(){
  let r=[null];
  for(let i=1;i<temps.length;i++)
    r.push((temps[i]-temps[i-1])/((times[i]-times[i-1])/60));
  return r;
}
function gasSeries(){
  let r=[],g=null,i=0;
  times.forEach(t=>{
    while(i<gasLog.length&&gasLog[i].time<=t){g=gasLog[i].gas;i++;}
    r.push(g);
  });
  return r;
}
function drawChart(){
  chart.data.labels=times.map(t=>t/60);
  chart.data.datasets=[
    {label:"Temp",data:temps,yAxisID:"tempAxis"},
    {label:"RoR",data:RoR(),yAxisID:"rorAxis"},
    {label:"Gas",data:gasSeries(),yAxisID:"gasAxis",stepped:true}
  ];
  chart.update();
}

/* ===== util ===== */
function sec(){return Math.floor((Date.now()-startTime)/1000);}

/* ===== init ===== */
initChart();
</script>

</body>
</html>