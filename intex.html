<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Roast Logger</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#fafafa;
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
  overscroll-behavior:none;
}
button{
  font-size:16px;
  padding:10px;
  margin:4px;
  width:100%;
  touch-action:manipulation;
}
#wrap{padding:8px}
#chartWrap{height:45vh}
</style>
</head>

<body>
<div id="wrap">

<div id="chartWrap">
<canvas id="chart"></canvas>
</div>

<button id="startBtn">焙煎開始</button>
<button id="dryBtn">Dry End（長押し）</button>
<button id="fcBtn">1ハゼ（長押し）</button>

</div>

<script>
/* ===== 状態 ===== */
let startTime=null,timerInt;
let times=[],temps=[];
let temp=150;
let gas=50;
let gasLog=[];
let dryEnd=null,fc=null,drop=null;

/* ===== util ===== */
const sec=()=>startTime?Math.floor((Date.now()-startTime)/1000):0;
const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;

/* ===== 時間軸拡張 ===== */
function ensureTimeRange(){
  const t=sec();
  const max=times.length-1;
  if(max===600 && t>600){
    for(let i=601;i<=900;i++){
      times.push(i);
      temps.push(null);
    }
  }
}

/* ===== フェーズ判定 ===== */
function phaseInfo(name,color,start,dur){
  const e=Math.max(0,sec()-start);
  const p=dur>0?Math.min(100,Math.round(e/dur*100)):0;
  return {name,color,elapsed:e,pct:p};
}
function currentPhaseInfo(){
  const t=sec();
  if(drop&&t>=drop) return {name:"FINISHED",color:"#999"};
  if(fc&&t>=fc){
    return phaseInfo("DEVELOPMENT","#e53935",fc,drop?drop-fc:90);
  }
  if(dryEnd&&t>=dryEnd){
    return phaseInfo("MAILLARD","#fb8c00",dryEnd,fc?fc-dryEnd:t-dryEnd);
  }
  if(startTime){
    return phaseInfo("DRYING","#fbc02d",0,dryEnd?dryEnd:t);
  }
  return null;
}

/* ===== Chart Plugin ===== */
const phaseLabelPlugin={
  id:"phaseLabel",
  afterDraw(chart){
    const p=currentPhaseInfo();
    if(!p) return;
    const {ctx,chartArea}=chart;
    ctx.save();
    ctx.textAlign="left";
    ctx.textBaseline="top";
    ctx.font="bold 14px sans-serif";
    ctx.fillStyle=p.color;
    ctx.fillText(p.name,chartArea.left+6,chartArea.top+6);
    ctx.font="12px sans-serif";
    ctx.fillStyle="#555";
    ctx.fillText(`${fmt(p.elapsed)} (${p.pct}%)`,chartArea.left+6,chartArea.top+24);
    ctx.restore();
  }
};

/* ===== 背景生成 ===== */
function phaseBg(s,e,color){
  if(s==null||e==null) return null;
  const d=Array(times.length).fill(null);
  for(let i=s;i<=e&&i<d.length;i++) d[i]=300;
  return {
    data:d,fill:true,backgroundColor:color,borderWidth:0,
    pointRadius:0,order:-10
  };
}
function phaseLine(t){
  if(t==null) return [];
  const d=Array(times.length).fill(null);
  if(t<d.length) d[t]=300;
  return d;
}

/* ===== Chart ===== */
const ctx=document.getElementById("chart");
const chart=new Chart(ctx,{
  type:"line",
  data:{labels:[],datasets:[]},
  options:{
    animation:false,
    scales:{
      y:{min:0,max:260},
      yG:{position:"right",grid:{drawOnChartArea:false}}
    }
  },
  plugins:[phaseLabelPlugin]
});

/* ===== 描画 ===== */
function drawChart(){
  ensureTimeRange();
  chart.data.labels=times.map(fmt);
  chart.data.datasets=[
    phaseBg(0,dryEnd,"rgba(255,235,59,0.25)"),
    phaseBg(dryEnd,fc,"rgba(255,152,0,0.22)"),
    phaseBg(fc,drop,"rgba(244,67,54,0.22)"),
    {label:"Temp",data:temps,borderWidth:2},
    {label:"Dry",data:phaseLine(dryEnd),borderColor:"#fbc02d",pointRadius:0},
    {label:"1C",data:phaseLine(fc),borderColor:"#e64a19",pointRadius:0}
  ].filter(Boolean);
  chart.update();
}

/* ===== 焙煎開始 ===== */
function startRoast(){
  startTime=Date.now();
  times=Array.from({length:601},(_,i)=>i);
  temps=Array(601).fill(null);
  temps[0]=temp;
  gasLog=[];
  dryEnd=fc=drop=null;
  clearInterval(timerInt);
  timerInt=setInterval(drawChart,1000);
  drawChart();
}
startBtn.onclick=startRoast;

/* ===== 長押し ===== */
let holdTimer=null;
function hold(type){
  holdTimer=setTimeout(()=>{
    if(type==="dry") dryEnd=sec();
    if(type==="fc") fc=sec();
    drawChart();
  },600);
}
function cancelHold(){clearTimeout(holdTimer);}

dryBtn.onpointerdown=e=>{e.preventDefault();hold("dry");};
dryBtn.onpointerup=cancelHold;
dryBtn.onpointercancel=cancelHold;

fcBtn.onpointerdown=e=>{e.preventDefault();hold("fc");};
fcBtn.onpointerup=cancelHold;
fcBtn.onpointercancel=cancelHold;

</script>
</body>
</html>
