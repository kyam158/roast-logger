<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Roast Logger 完成版</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 10px;
}
button {
  padding: 12px;
  margin: 6px;
  font-size: 16px;
  touch-action: manipulation;
}
input {
  font-size: 20px;
  width: 80px;
  text-align: center;
}
h2,h3 { text-align:center }
#timer { font-size:36px; text-align:center; margin:10px }
#phaseInfo { text-align:center; font-size:16px }
</style>
</head>

<body>

<h2>☕ Roast Logger（完成版）</h2>

<div style="text-align:center">
  投入温度 <input id="chargeTemp" type="number" value="200">℃
</div>

<div style="text-align:center">
  初期ガス <input id="chargeGas" type="number" step="0.1" value="0.5">
</div>

<div style="text-align:center">
  <button onclick="startRoast()">焙煎スタート</button>
</div>

<div id="timer">00:00</div>

<h3>温度</h3>
<div style="text-align:center">
  <button onclick="safeTap(()=>temp-- )">−</button>
  <input id="tempInput" value="200">
  <button onclick="safeTap(()=>temp++ )">＋</button><br>
  <button onclick="safeTap(addTemp)">温度追加</button>
</div>

<h3>ガス圧</h3>
<div style="text-align:center">
  <button onclick="safeTap(()=>setGas(-0.1))">−</button>
  <span id="gasDisp" style="font-size:24px">0.5</span>
  <button onclick="safeTap(()=>setGas(0.1))">＋</button><br>
  <button onclick="safeTap(recordGas)">ガス圧記録</button>
</div>

<h3>フェーズ</h3>
<div style="text-align:center">
  <button ontouchstart="hold('dry')" ontouchend="cancelHold()">Dry End（長押し）</button>
  <button ontouchstart="hold('fc')" ontouchend="cancelHold()">1ハゼ（長押し）</button>
  <button onclick="safeTap(setDrop)">Drop</button>
</div>

<div id="phaseInfo">フェーズ未確定</div>

<canvas id="chart"></canvas>

<script>
let timerInt, startTime;
let times=[], temps=[], gasLog=[];
let temp=200, gas=0.5;
let dryEnd=null, fc=null, drop=null;
let chart;

/* ===== 安全タップ ===== */
let lastTap=0;
function safeTap(fn){
  const n=Date.now();
  if(n-lastTap<400) return;
  lastTap=n; fn();
}

/* ===== タイマー ===== */
function startRoast(){
  startTime=Date.now();
  times=[0];
  temps=[Number(chargeTemp.value)];
  gas=Number(chargeGas.value);
  gasLog=[{time:0,gas}];
  temp=temps[0];
  tempInput.value=temp;
  gasDisp.textContent=gas.toFixed(1);
  dryEnd=fc=drop=null;
  clearInterval(timerInt);
  timerInt=setInterval(updateTimer,1000);
  drawChart();
}
function sec(){ return Math.floor((Date.now()-startTime)/1000); }
function updateTimer(){
  const s=sec();
  timer.textContent=Math.floor(s/60)+":"+String(s%60).padStart(2,"0");
  drawChart();
}

/* ===== 温度 ===== */
function addTemp(){
  times.push(sec());
  temps.push(temp);
  drawChart();
}

/* ===== ガス ===== */
function setGas(d){
  gas=Math.max(0,Math.round((gas+d)*10)/10);
  gasDisp.textContent=gas.toFixed(1);
}
function recordGas(){
  gasLog.push({time:sec(),gas});
  drawChart();
}

/* ===== フェーズ ===== */
let holdTimer;
function hold(t){
  holdTimer=setTimeout(()=>{
    if(t==="dry") dryEnd=sec();
    if(t==="fc") fc=sec();
    navigator.vibrate?.(100);
    updatePhaseInfo();
    drawChart();
  },1500);
}
function cancelHold(){ clearTimeout(holdTimer); }
function setDrop(){
  drop=sec();
  clearInterval(timerInt);
  updatePhaseInfo();
  drawChart();
}

/* ===== フェーズ表示 ===== */
function updatePhaseInfo(){
  let now=drop??sec();
  let txt="";
  if(dryEnd) txt+=`Dry ${fmt(dryEnd)}<br>`;
  if(dryEnd&&fc) txt+=`Maillard ${fmt(fc-dryEnd)}<br>`;
  if(fc) txt+=`Dev ${fmt(now-fc)}<br>`;
  if(dryEnd&&fc&&drop){
    txt+=`<hr>
    Dry ${Math.round(dryEnd/drop*100)}% /
    Mai ${Math.round((fc-dryEnd)/drop*100)}% /
    Dev ${Math.round((drop-fc)/drop*100)}%`;
  }
  phaseInfo.innerHTML=txt||"フェーズ未確定";
}
function fmt(s){ return Math.floor(s/60)+":"+String(s%60).padStart(2,"0"); }

/* ===== グラフ ===== */
function gasSeries(){
  let g=null,i=0,r=[];
  times.forEach(t=>{
    while(i<gasLog.length&&gasLog[i].time<=t){g=gasLog[i].gas;i++;}
    r.push(g);
  });
  return r;
}

function drawChart(){
  const labels=times.map(t=>{
    const m=Math.floor(t/60),s=String(t%60).padStart(2,"0");
    return `${m}:${s}`;
  });
  const bg=[];
  if(dryEnd) bg.push({xMin:0,xMax:dryEnd,backgroundColor:"rgba(255,215,0,0.2)"});
  if(fc) bg.push({xMin:dryEnd,xMax:fc,backgroundColor:"rgba(255,165,0,0.2)"});
  if(drop) bg.push({xMin:fc,xMax:drop,backgroundColor:"rgba(255,99,71,0.25)"});

  if(!chart){
    chart=new Chart(chartCtx,{
      type:"line",
      data:{labels,datasets:[]},
      options:{
        scales:{
          y:{title:{display:true,text:"Temp ℃"}},
          yR:{position:"right",grid:{drawOnChartArea:false},title:{display:true,text:"RoR"}},
          yG:{position:"right",grid:{drawOnChartArea:false},title:{display:true,text:"Gas"}}
        },
        plugins:{legend:{display:true}}
      }
    });
  }
  chart.data.labels=labels;
  chart.data.datasets=[
    {label:"Temp",data:temps,tension:.3},
    {label:"RoR",data:temps.map((v,i)=>i?((v-temps[i-1])/((times[i]-times[i-1])/60)):null),yAxisID:"yR"},
    {label:"Gas",data:gasSeries(),yAxisID:"yG",stepped:true}
  ];
  chart.update();
}

/* DOM */
const chargeTemp=document.getElementById("chargeTemp");
const chargeGas=document.getElementById("chargeGas");
const tempInput=document.getElementById("tempInput");
const gasDisp=document.getElementById("gasDisp");
const timer=document.getElementById("timer");
const phaseInfo=document.getElementById("phaseInfo");
const chartCtx=document.getElementById("chart");
</script>

</body>
</html>