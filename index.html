<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roast Logger</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body{margin:0;font-family:-apple-system;background:#fafafa}
#wrap{padding:10px}
#chartWrap{height:45vh}
button,input{width:100%;padding:12px;margin:6px 0;font-size:16px}
.row{display:flex;gap:6px}
.row>*{flex:1}
#dropBtn{background:#d32f2f;color:#fff;font-weight:bold}
#csvBtn{background:#1976d2;color:#fff}
#time{text-align:center;font-size:22px;margin:6px 0}
button {
  touch-action: manipulation;
}
</style>
</head>

<body>
<div id="wrap">
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="time">0:00</div>

<label>開始温度 (℃)</label>
<div class="row">
  <input id="startTempInput" type="number" value="150">
</div>
  <button id="startBtn">焙煎開始</button>

  <label>豆温 (℃)</label>
  <div class="row">
    <input id="tempInput" type="number" value="150">
    <button id="tempSet">決定</button>
  </div>

  <label>ガス圧</label>
<div class="row">
  <button id="gasDown">−</button>
  <div id="gasLabel" style="text-align:center;font-size:20px;line-height:48px">
    2.5
  </div>
  <button id="gasUp">＋</button>
</div>

<button id="chargeBtn">Charge</button>
<button id="tpBtn">Turning Point</button>
  <button id="dryBtn">Dry End（長押し）</button>
  <button id="fcBtn">1ハゼ（長押し）</button>
  <button id="dropBtn">DROP</button>

  <button id="csvBtn">CSV書き出し</button>
</div>

<script>
/* =====================
   util
===================== */
const fmt = s =>
  `${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;

const secToMinSec = s =>
  `${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;

/* =====================
   状態
===================== */
let startTime=null,endTime=null,timer=null;
let startTemp = 150;
let temp=150,gas=2.5;
let dryEnd=null,fc=null;
let charge=null,tp=null;
let tpTemp=null;
let dryEndTemp=null;
let fcTemp=null;
let dropTemp=null;
const tempData=[],gasData=[];

const nowSec=()=> endTime ?? Math.floor((Date.now()-startTime)/1000);

/* =====================
   Chart
===================== */
const chart=new Chart(
  document.getElementById("chart"),
  {
    type:"line",
    data:{datasets:[
      {
  label:"Temp",
  data:[],
  borderWidth:2,
  tension:0.3,
  cubicInterpolationMode:"monotone"
},
      {label:"Gas",data:[],yAxisID:"yR",borderDash:[4,4]}
    ]},
    options:{
      animation:false,
      scales:{
        x:{
  type:"linear",
  min:0,
  ticks:{
    stepSize:60,
    callback:(value)=>{
      const m = Math.floor(value / 60);
      return `${m}:00`;
    }
  }
},
        y:{
  min:0,
  max:260,
  ticks:{
    stepSize:20
  }
},
        yR:{position:"right",min:0,max:5,grid:{drawOnChartArea:false}}
      }
    },

    /* ★ ここから追加 */
    plugins:[
      {
        id:"phaseMarkers",
        afterDraw(chart){
          const {ctx,scales,chartArea}=chart;

          function drawLine(t, tempValue, color, label){
  if(t==null) return;

  const x = scales.x.getPixelForValue(t);

  ctx.save();

  // 縦線
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x, chartArea.top);
  ctx.lineTo(x, chartArea.bottom);
  ctx.stroke();

  // ラベル（文字）
  ctx.fillStyle = color;
  ctx.font = "12px sans-serif";

  const tempText =
    tempValue != null ? ` ${tempValue}℃` : "";

  ctx.fillText(
    label + tempText,
    x + 4,
    chartArea.top + 12
  );

  ctx.restore();
}
drawLine(charge, startTemp, "#1565c0", "Charge");
drawLine(tp, tpTemp, "#2e7d32", "TP");
drawLine(dryEnd, dryEndTemp, "#f9a825", "Dry End");
drawLine(fc, fcTemp, "#e65100", "1st Crack");
        }
      },
       // ★★★ ここに追加 ★★★
  {
    id:"developmentText",
    afterDraw(chart){
      if(fc == null || endTime == null) return;

      const ctx = chart.ctx;
      const { left, top } = chart.chartArea;

      const devTime = endTime - fc;
      const devRate = (devTime / endTime * 100).toFixed(1);

      const m = Math.floor(devTime / 60);
      const s = devTime % 60;

      ctx.save();
      ctx.fillStyle = "#e53935";
      ctx.font = "bold 14px sans-serif";
      ctx.fillText("DEVELOPMENT", left + 6, top + 16);

      ctx.fillStyle = "#333";
      ctx.font = "13px sans-serif";
      ctx.fillText(
        `${m}:${String(s).padStart(2,"0")} (${devRate}%)`,
        left + 6,
        top + 34
      );
      ctx.restore();
    }
  }
]
  }
);
  /* =====================
   描画
===================== */
function draw(){
  if(!startTime) return;

  const t = nowSec();
  time.textContent = fmt(t);

  chart.options.scales.x.max = Math.max(600, t + 10);
  chart.data.datasets[0].data = tempData;
  chart.data.datasets[1].data = gasData;
  chart.update();
}
/* =====================
   操作
===================== */
startBtn.onclick=()=>{
  startTemp = parseInt(startTempInput.value) || startTemp;
  temp = startTemp; // ← 現在温度も同期

  startTime=Date.now();
  endTime=null;
  dryEnd=fc=null;

  tempData.length=0;
  gasData.length=0;

  tempData.push({x:0,y:startTemp});
  gasData.push({x:0,y:gas});

  clearInterval(timer);
  timer=setInterval(draw,1000);
  draw();
};

tempSet.onclick=()=>{
  temp=parseInt(tempInput.value)||temp;
  tempData.push({x:nowSec(),y:temp});
  draw();
};

const setGas = v => {
  gas = Math.min(5, Math.max(0, Number(v.toFixed(1))));
  gasLabel.textContent = gas.toFixed(1);
  gasData.push({ x: nowSec(), y: gas });
  draw();
};

gasUp.onpointerdown = e => {
  e.preventDefault();
  setGas(gas + 0.1);
};

gasDown.onpointerdown = e => {
  e.preventDefault();
  setGas(gas - 0.1);
};

/* =====================
   長押し
===================== */
let hold=null;
const holdStart=f=>hold=setTimeout(f,600);
const holdCancel=()=>clearTimeout(hold);

dryBtn.onpointerdown = e => {
  e.preventDefault();
  holdStart(()=>{
    dryEnd = nowSec();
    dryEndTemp = temp;   // ★ 温度
  });
};
fcBtn.onpointerdown = e => {
  e.preventDefault();
  holdStart(()=>{
    fc = nowSec();
    fcTemp = temp;   // ★ 温度
  });
};
[dryBtn,fcBtn].forEach(b=>{
  b.onpointerup = holdCancel;
  b.onpointercancel = holdCancel;
});
chargeBtn.onclick = () => {
  if(!startTime) return;
  charge = nowSec();
  draw();
};

tpBtn.onclick = () => {
  if(!startTime) return;
  tp = nowSec();
  tpTemp = temp;   // ★ 温度を保存
  draw();
};
/* =====================
   DROP
===================== */
dropBtn.onclick = () => {
  if(!startTime || endTime) return;
  endTime = nowSec();
  dropTemp = temp;   // ★ 温度
  clearInterval(timer);
  draw();
};

/* =====================
   CSV書き出し
===================== */
csvBtn.onclick=()=>{
  if(!tempData.length) return alert("データなし");

  const devTime =
    (fc != null && endTime != null)
      ? (endTime - fc)
      : null;

  const devRate =
    (devTime != null && endTime > 0)
      ? (devTime / endTime * 100).toFixed(1)
      : null;

  let csv=[
    "# Roast Logger CSV",
    "# ChargeTemp," + (charge!=null ? startTemp : ""),
"# TurningPointTemp," + (tpTemp ?? ""),
"# DryEndTemp," + (dryEndTemp ?? ""),
"# FirstCrackTemp," + (fcTemp ?? ""),
"# DropTemp," + (dropTemp ?? ""),
    "# Charge," + (charge ?? ""),
"# TurningPoint," + (tp ?? ""),
    `# DryEnd,${dryEnd ?? ""}`,
    `# FirstCrack,${fc ?? ""}`,
    `# Drop,${endTime ?? ""}`,
    `# DevelopmentTime,${devTime ?? ""}`,
    `# DevelopmentRate,${devRate ?? ""}`,
    "time(mm:ss),temperature(C),gas"
  ];

  const map={};
  tempData.forEach(d=>{
    map[d.x]=map[d.x]||{};
    map[d.x].t=d.y;
  });
  gasData.forEach(d=>{
    map[d.x]=map[d.x]||{};
    map[d.x].g=d.y;
  });

  Object.keys(map).sort((a,b)=>a-b).forEach(t=>{
    csv.push(
      `${secToMinSec(Number(t))},${map[t].t??""},${map[t].g??""}`
    );
  });

  const blob=new Blob([csv.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`roast_${Date.now()}.csv`;
  a.click();
};
</script>
</body>
</html>

