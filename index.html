<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roast Logger</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body{margin:0;font-family:-apple-system;background:#fafafa}
#wrap{padding:10px}
#chartWrap{height:45vh}
button,input{width:100%;padding:12px;margin:6px 0;font-size:16px}
.row{display:flex;gap:6px}
.row>*{flex:1}
#dropBtn{background:#d32f2f;color:#fff;font-weight:bold}
#time{text-align:center;font-size:22px;margin:6px 0}
</style>
</head>

<body>
<div id="wrap">
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="time">0:00</div>

  <button id="startBtn">焙煎開始</button>

  <label>豆温 (℃)</label>
  <div class="row">
    <input id="tempInput" type="number" value="150">
    <button id="tempSet">決定</button>
  </div>

  <label>ガス圧 (<span id="gasLabel">2.5</span>)</label>
  <input id="gasInput" type="range" min="0" max="5" step="0.5" value="2.5">

  <button id="dryBtn">Dry End</button>
  <button id="fcBtn">1ハゼ</button>
  <button id="dropBtn">DROP</button>
  <button id="saveBtn">グラフ保存（PNG）</button>
</div>

<script>
/* ===== 状態 ===== */
let startTime=null,endTime=null,timer=null;
let temp=150,gas=2.5;
let dryEnd=null,fc=null;
const tempData=[],gasData=[];

/* util */
const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;
const nowSec=()=> endTime ?? Math.floor((Date.now()-startTime)/1000);

/* ===== フェーズ判定 ===== */
function phaseInfo(t){
  if(fc!=null && t>=fc){
    const dur=endTime?endTime-fc:t-fc;
    return {name:"DEVELOPMENT",color:"#e53935",start:fc,dur};
  }
  if(dryEnd!=null && t>=dryEnd){
    const dur=fc?fc-dryEnd:t-dryEnd;
    return {name:"MAILLARD",color:"#fb8c00",start:dryEnd,dur};
  }
  if(startTime){
    const dur=dryEnd?dryEnd:t;
    return {name:"DRYING",color:"#fbc02d",start:0,dur};
  }
  return null;
}

/* ===== Chart ===== */
const chart = new Chart(
  document.getElementById("chart"),
  {
    type:"line",
    data:{
      datasets:[
        {label:"Temp",data:[],borderWidth:2},
        {label:"Gas",data:[],yAxisID:"yR",borderDash:[4,4]}
      ]
    },
    options:{
      animation:false,
      scales:{
        x:{type:"linear",min:0},
        y:{min:0,max:260},
        yR:{position:"right",min:0,max:5,grid:{drawOnChartArea:false}}
      }
    },
    plugins:[{
      id:"markers",
      afterDraw(c){
        const {ctx,scales,chartArea}=c;
        ctx.save();

        function vline(t,color){
          if(t==null) return;
          const x=scales.x.getPixelForValue(t);
          ctx.strokeStyle=color;
          ctx.lineWidth=2;
          ctx.beginPath();
          ctx.moveTo(x,chartArea.top);
          ctx.lineTo(x,chartArea.bottom);
          ctx.stroke();
        }

        vline(dryEnd,"#fbc02d"); // Dry End
        vline(fc,"#e65100");     // 1st Crack

        const t=nowSec();
        const p=phaseInfo(t);
        if(p){
          const elapsed=t-p.start;
          const pct=p.dur?Math.min(100,Math.round(elapsed/p.dur*100)):0;
          ctx.fillStyle=p.color;
          ctx.font="bold 14px sans-serif";
          ctx.fillText(p.name,chartArea.left+6,chartArea.top+18);
          ctx.fillStyle="#555";
          ctx.font="12px sans-serif";
          ctx.fillText(`${fmt(elapsed)} (${pct}%)`,chartArea.left+6,chartArea.top+34);
        }

        ctx.restore();
      }
    }]
  }
);

/* ===== 描画 ===== */
function draw(){
  const t=nowSec();
  time.textContent=fmt(t);
  chart.options.scales.x.max=Math.max(600,t+10);
  chart.data.datasets[0].data=tempData;
  chart.data.datasets[1].data=gasData;
  chart.update();
}

/* ===== 操作 ===== */
startBtn.onclick=()=>{
  startTime=Date.now();
  endTime=null;
  dryEnd=fc=null;
  tempData.length=0;
  gasData.length=0;
  tempData.push({x:0,y:temp});
  gasData.push({x:0,y:gas});
  clearInterval(timer);
  timer=setInterval(draw,1000);
  draw();
};

tempSet.onclick=()=>{
  temp=parseInt(tempInput.value)||temp;
  tempData.push({x:nowSec(),y:temp});
  draw();
};

gasInput.oninput=()=>{
  gas=parseFloat(gasInput.value);
  gasLabel.textContent=gas.toFixed(1);
  gasData.push({x:nowSec(),y:gas});
  draw();
};

dryBtn.onclick=()=>{ if(startTime && dryEnd==null) dryEnd=nowSec(); };
fcBtn.onclick=()=>{ if(startTime && fc==null) fc=nowSec(); };

dropBtn.onclick=()=>{
  if(!startTime||endTime) return;
  endTime=nowSec();
  clearInterval(timer);
  draw();
};
  /* =====================
   グラフ保存（PNG）
===================== */
<input id="roastName" placeholder="焙煎名（例：Brazil Light）">
  /* =====================
   グラフ保存（焙煎名焼き込み）
===================== */
saveBtn.onclick = () => {
  const canvas = chart.canvas;
  const ctx = canvas.getContext("2d");

  // 焙煎名
  const name = roastName.value || "Roast Logger";

  // 元の状態保存
  ctx.save();

  // 半透明背景
  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.fillRect(0, 0, canvas.width, 50);

  // テキスト
  ctx.fillStyle = "#000";
  ctx.font = "bold 20px sans-serif";
  ctx.textBaseline = "middle";
  ctx.fillText(name, 12, 25);

  // 時刻も入れる（任意）
  ctx.font = "12px sans-serif";
  ctx.fillStyle = "#555";
  ctx.fillText(
    new Date().toLocaleString(),
    canvas.width - 160,
    25
  );

  // PNG生成
  const url = canvas.toDataURL("image/png", 1);

  // 元に戻す
  ctx.restore();
  chart.update();

  // ダウンロード
  const a = document.createElement("a");
  a.href = url;
  a.download = `roast_${name.replace(/\s+/g,"_")}.png`;
  a.click();
};
</script>
</body>
</html>
