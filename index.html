<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Roast Logger</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#fafafa;
  user-select:none;
}
#wrap{padding:10px}
#chartWrap{height:45vh}
button,input{
  width:100%;
  padding:12px;
  margin:6px 0;
  font-size:16px;
}
.row{display:flex;gap:6px}
.row>*{flex:1}
label{font-size:13px;color:#555}
#dropBtn{background:#d32f2f;color:#fff;font-weight:bold}
#history div{
  padding:8px;
  border-bottom:1px solid #ddd;
}
.smallBtn{
  font-size:12px;
  padding:4px;
}
</style>
</head>

<body>
<div id="wrap">

<div id="chartWrap"><canvas id="chart"></canvas></div>

<button id="startBtn">ç„™ç…é–‹å§‹</button>

<label>è±†æ¸© (â„ƒ)</label>
<div class="row">
  <input id="tempInput" type="number" value="150">
  <button id="tempSet">æ±ºå®š</button>
</div>

<label>ã‚¬ã‚¹åœ§ (<span id="gasLabel">2.5</span>)</label>
<input id="gasInput" type="range" min="0" max="5" step="0.5" value="2.5">

<button id="dryBtn">Dry Endï¼ˆé•·æŠ¼ã—ï¼‰</button>
<button id="fcBtn">1ãƒã‚¼ï¼ˆé•·æŠ¼ã—ï¼‰</button>
<button id="dropBtn">DROP</button>

<h3>å±¥æ­´</h3>
<div id="history"></div>

</div>

<script>
/* ===== çŠ¶æ…‹ ===== */
const KEY="roastHistory";
let startTime=null,timer=null,replayMode=false;
let times=[],temps=[],rors=[],gases=[];
let temp=150, gas=2.5;
let dryEnd=null,fc=null,drop=null;

/* ===== util ===== */
const sec=()=>startTime?Math.floor((Date.now()-startTime)/1000):0;
const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;

/* ===== æ™‚é–“è»¸ ===== */
function ensureRange(){
  const target = sec()>600 ? 900 : 600;
  while(times.length-1 < target){
    times.push(times.length);
    temps.push(null);
    rors.push(null);
    gases.push(null);
  }
}

/* ===== RoR ===== */
function calcRoR(){
  rors.fill(null);
  for(let i=30;i<temps.length;i++){
    if(temps[i]!=null && temps[i-30]!=null){
      rors[i]=(temps[i]-temps[i-30])*2;
    }
  }
}

/* ===== ãƒ•ã‚§ãƒ¼ã‚º ===== */
function phaseInfo(name,color,start,dur){
  const e=Math.max(0,sec()-start);
  const p=dur?Math.round(e/dur*100):0;
  return {name,color,elapsed:e,pct:p};
}
function currentPhase(){
  const t=sec();
  if(fc && t>=fc) return phaseInfo("DEVELOPMENT","#e53935",fc,drop?drop-fc:0);
  if(dryEnd && t>=dryEnd) return phaseInfo("MAILLARD","#fb8c00",dryEnd,fc?fc-dryEnd:t-dryEnd);
  if(startTime) return phaseInfo("DRYING","#fbc02d",0,dryEnd?dryEnd:t);
  return null;
}

/* ===== Chart ===== */
const chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{labels:[],datasets:[]},
  options:{
    animation:false,
    plugins:{
      legend:{labels:{filter:l=>l.text}},
      phaseLabel:{
        afterDraw(c){
          const p=currentPhase();
          if(!p) return;
          const {ctx,chartArea}=c;
          ctx.save();
          ctx.fillStyle=p.color;
          ctx.font="bold 14px sans-serif";
          ctx.fillText(p.name,chartArea.left+6,chartArea.top+6);
          ctx.font="12px sans-serif";
          ctx.fillStyle="#555";
          ctx.fillText(`${fmt(p.elapsed)} (${p.pct}%)`,chartArea.left+6,chartArea.top+24);
          ctx.restore();
        }
      }
    },
    scales:{
      x:{
        ticks:{
          callback:(value,index)=> index%60===0 ? fmt(index) : ""
        }
      },
      y:{min:0,max:260,title:{display:true,text:"Temp"}},
      yR:{position:"right",min:-10,max:10,grid:{drawOnChartArea:false}}
    }
  }
});

/* ===== æç”» ===== */
function draw(){
  ensureRange();
  chart.data.labels = times.map(fmt);
  chart.data.datasets=[
    {label:"Temp",data:temps,borderWidth:2,yAxisID:"y"},
    {label:"RoR",data:rors,borderColor:"#7b1fa2",yAxisID:"yR"},
    {label:"Gas",data:gases,borderColor:"#1976d2",borderDash:[4,4],yAxisID:"yR"}
  ];
  chart.update();
}

/* ===== ç„™ç…é–‹å§‹ ===== */
startBtn.onclick=()=>{
  replayMode=false;
  startTime=Date.now();
  dryEnd=fc=drop=null;
  times=Array.from({length:601},(_,i)=>i);
  temps=Array(601).fill(null);
  rors=Array(601).fill(null);
  gases=Array(601).fill(null);
  temps[0]=temp;
  gases[0]=gas;
  clearInterval(timer);
  timer=setInterval(draw,1000);
  draw();
};

/* ===== å…¥åŠ› ===== */
tempSet.onclick=()=>{
  temp=parseInt(tempInput.value)||temp;
  const t=sec();
  if(t<temps.length) temps[t]=temp;
  calcRoR(); draw();
};
gasInput.oninput=()=>{
  gas=parseFloat(gasInput.value);
  gasLabel.textContent=gas.toFixed(1);
  const t=sec();
  if(t<gases.length) gases[t]=gas;
  draw();
};

/* ===== é•·æŠ¼ã— ===== */
let hold=null;
const startHold=fn=>hold=setTimeout(fn,600);
const cancelHold=()=>clearTimeout(hold);
dryBtn.onpointerdown=e=>{e.preventDefault();startHold(()=>{dryEnd=sec();});};
fcBtn.onpointerdown=e=>{e.preventDefault();startHold(()=>{fc=sec();});};
[dryBtn,fcBtn].forEach(b=>{b.onpointerup=cancelHold;b.onpointercancel=cancelHold;});

dropBtn.onclick=()=>{
  if(!startTime||drop||!fc) return;
  drop=sec();
  saveHistory();
};

/* ===== å±¥æ­´ ===== */
function loadHistory(){
  return JSON.parse(localStorage.getItem(KEY)||"[]");
}
function saveHistory(){
  const h=loadHistory();
  h.unshift({
    id:Date.now(),
    name:"",
    date:new Date().toLocaleString(),
    drop,dryEnd,fc,
    temps:[...temps],
    gases:[...gases]
  });
  localStorage.setItem(KEY,JSON.stringify(h));
  renderHistory();
}
function renderHistory(){
  const h=loadHistory();
  history.innerHTML=h.length?h.map((r,i)=>`
    <div>
      <b onclick="replay(${i})">${r.name||"ï¼ˆåç§°æœªè¨­å®šï¼‰"}</b><br>
      <small>${r.date}</small>
      <div class="row">
        <button class="smallBtn" onclick="editName(${i})">ğŸ–Š</button>
        <button class="smallBtn" onclick="del(${i})">ğŸ—‘</button>
      </div>
    </div>
  `).join(""):"å±¥æ­´ãªã—";
}
function editName(i){
  const h=loadHistory();
  const n=prompt("ç„™ç…å",h[i].name||"");
  if(n!==null){h[i].name=n;localStorage.setItem(KEY,JSON.stringify(h));renderHistory();}
}
function del(i){
  if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    const h=loadHistory();
    h.splice(i,1);
    localStorage.setItem(KEY,JSON.stringify(h));
    renderHistory();
  }
}
function replay(i){
  const r=loadHistory()[i];
  replayMode=true;
  clearInterval(timer);
  startTime=Date.now()-r.drop*1000;
  temps=[...r.temps];
  gases=[...r.gases];
  times=temps.map((_,i)=>i);
  calcRoR();
  draw();
}

renderHistory();
</script>
</body>
</html>
