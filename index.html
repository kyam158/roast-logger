<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roast Logger</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body{margin:0;font-family:-apple-system;background:#fafafa}
#wrap{padding:10px}
#chartWrap{height:45vh}
button,input{width:100%;padding:12px;margin:6px 0;font-size:16px}
.row{display:flex;gap:6px}
.row>*{flex:1}
#dropBtn{background:#d32f2f;color:#fff;font-weight:bold}
#imgBtn{background:#2e7d32;color:#fff}
#csvBtn{background:#1976d2;color:#fff}
#time{text-align:center;font-size:22px;margin:6px 0}
</style>
</head>

<body>
<div id="wrap">
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="time">0:00</div>

  <button id="startBtn">焙煎開始</button>

  <input id="roastName" placeholder="焙煎名（例：Ethiopia Light）">
  <input id="beanName" placeholder="豆名">
  <input id="weight" type="number" placeholder="投入量(g)">
  <input id="roastLevel" placeholder="焙煎度（Light / Medium）">

  <label>豆温 (℃)</label>
  <div class="row">
    <input id="tempInput" type="number" value="150">
    <button id="tempSet">決定</button>
  </div>

  <label>ガス圧 (<span id="gasLabel">2.5</span>)</label>
  <input id="gasInput" type="range" min="0" max="5" step="0.5" value="2.5">

  <button id="dryBtn">Dry End（長押し）</button>
  <button id="fcBtn">1ハゼ（長押し）</button>
  <button id="dropBtn">DROP</button>

  <button id="imgBtn">グラフ画像保存</button>
  <button id="csvBtn">CSV書き出し</button>
</div>

<script>
let startTime=null,endTime=null,timer=null;
let temp=150,gas=2.5;
let dryEnd=null,fc=null;
const tempData=[],gasData=[];

const fmt = s => {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${m}分${sec}秒`;
};
const nowSec=()=>endTime ?? Math.floor((Date.now()-startTime)/1000);

/* ===== Chart ===== */
const chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{datasets:[
    {label:"Temp",data:[],borderWidth:2},
    {label:"Gas",data:[],yAxisID:"yR",borderDash:[4,4]}
  ]},
  options:{
    animation:false,
    scales:{
      x:{type:"linear",min:0},
      y:{min:0,max:260},
      yR:{position:"right",min:0,max:5,grid:{drawOnChartArea:false}}
    }
  },
  plugins:[{
    id:"markers",
    afterDraw(c){
      const {ctx,scales,chartArea}=c;
      ctx.save();
      function vline(t,color){
        if(t==null) return;
        const x=scales.x.getPixelForValue(t);
        ctx.strokeStyle=color;
        ctx.beginPath();
        ctx.moveTo(x,chartArea.top);
        ctx.lineTo(x,chartArea.bottom);
        ctx.stroke();
      }
      vline(dryEnd,"#fbc02d");
      vline(fc,"#e65100");
      ctx.restore();
    }
  }]
});

/* ===== 描画 ===== */
function draw(){
  const t=nowSec();
  time.textContent=fmt(t);
  chart.options.scales.x.max=Math.max(600,t+10);
  chart.data.datasets[0].data=tempData;
  chart.data.datasets[1].data=gasData;
  chart.update();
}

/* ===== 操作 ===== */
startBtn.onclick=()=>{
  startTime=Date.now();
  endTime=null;
  dryEnd=fc=null;
  tempData.length=0;
  gasData.length=0;
  tempData.push({x:0,y:temp});
  gasData.push({x:0,y:gas});
  clearInterval(timer);
  timer=setInterval(draw,1000);
  draw();
};

tempSet.onclick=()=>{
  temp=parseInt(tempInput.value)||temp;
  tempData.push({x:nowSec(),y:temp});
  draw();
};

gasInput.oninput=()=>{
  gas=parseFloat(gasInput.value);
  gasLabel.textContent=gas.toFixed(1);
  gasData.push({x:nowSec(),y:gas});
  draw();
};

/* 長押し */
let hold=null;
const holdStart=f=>hold=setTimeout(f,600);
const holdCancel=()=>clearTimeout(hold);

dryBtn.onpointerdown=e=>{e.preventDefault();holdStart(()=>dryEnd=nowSec());};
fcBtn.onpointerdown=e=>{e.preventDefault();holdStart(()=>fc=nowSec());};
[dryBtn,fcBtn].forEach(b=>{
  b.onpointerup=holdCancel;
  b.onpointercancel=holdCancel;
});

/* DROP */
dropBtn.onclick=()=>{
  if(!startTime||endTime) return;
  endTime=nowSec();
  clearInterval(timer);
  draw();
};

/* ===== 画像保存 ===== */
imgBtn.onclick=()=>{
  const canvas=chart.canvas;
  const ctx=canvas.getContext("2d");

  const roast=roastName.value||"Roast Logger";
  const info=[beanName.value,weight.value?weight.value+"g":"",roastLevel.value]
    .filter(v=>v).join(" / ");

  const img=new Image();
  img.src=canvas.toDataURL();
  img.onload=()=>{
    const out=document.createElement("canvas");
    out.width=canvas.width;
    out.height=canvas.height+72;
    const octx=out.getContext("2d");

    octx.fillStyle="#fff";
    octx.fillRect(0,0,out.width,out.height);
    octx.drawImage(img,0,72);

    octx.font="bold 18px sans-serif";
    octx.fillStyle="#000";
    octx.fillText(roast,12,24);

    if(info){
      octx.font="14px sans-serif";
      octx.fillStyle="#333";
      octx.fillText(info,12,46);
    }

    const a=document.createElement("a");
    a.href=out.toDataURL("image/png");
    a.download=`roast_${Date.now()}.png`;
    a.click();
  };
};

/* ===== CSV ===== */
csvBtn.onclick=()=>{
  if(!tempData.length) return alert("データなし");
  let csv=[
    "# Roast Logger CSV",
    `# DryEnd,${dryEnd??""}`,
    `# FirstCrack,${fc??""}`,
    `# Drop,${endTime??""}`,
    "time,temperature,gas"
  ];
  const map={};
  tempData.forEach(d=>{map[d.x]=map[d.x]||{};map[d.x].t=d.y});
  gasData.forEach(d=>{map[d.x]=map[d.x]||{};map[d.x].g=d.y});
  Object.keys(map).sort((a,b)=>a-b).forEach(t=>{
    csv.push(`${t},${map[t].t??""},${map[t].g??""}`);
  });
  const blob=new Blob([csv.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`roast_${Date.now()}.csv`;
  a.click();
};
</script>
</body>
</html>
