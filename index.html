<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roast Logger CORE</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
body{font-family:-apple-system;background:#fafafa;margin:0;padding:10px}
#time{font-size:28px;text-align:center;margin:8px 0}
button,input{width:100%;padding:12px;margin:6px 0;font-size:16px}
</style>
</head>

<body>

<canvas id="chart" height="300"></canvas>
<div id="time">0:00</div>

<button id="start">焙煎開始</button>
<input id="temp" type="number" value="150">
<input id="gas" type="range" min="0" max="5" step="0.5" value="2.5">
<button id="drop">DROP</button>

<script>
let timer = null;
let startTime = 0;

const temps = [];
const gases = [];

const fmt = s => `${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;

const chart = new Chart(document.getElementById("chart"),{
  type:"line",
  data:{
    datasets:[
      {label:"Temp",data:[],borderWidth:2},
      {label:"Gas",data:[],borderDash:[4,4],yAxisID:"yR"}
    ]
  },
  options:{
    animation:false,
    scales:{
      x:{type:"linear",min:0,max:600},
      y:{min:0,max:260},
      yR:{position:"right",min:0,max:5,grid:{drawOnChartArea:false}}
    }
  }
});

function draw(t){
  time.textContent = fmt(t);
  chart.data.datasets[0].data = temps;
  chart.data.datasets[1].data = gases;
  chart.update();
}

start.onclick = () => {
  if(timer) return;          // ← 二重起動防止（重要）
  temps.length = 0;
  gases.length = 0;
  startTime = Date.now();

  timer = setInterval(()=>{
    const t = Math.floor((Date.now()-startTime)/1000);
    temps.push({x:t,y:+temp.value});
    gases.push({x:t,y:+gas.value});
    draw(t);
  },1000);
};

drop.onclick = () => {
  if(!timer) return;
  clearInterval(timer);
  timer = null;              // ← 完全停止
};
</script>

</body>
</html>
