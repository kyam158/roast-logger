<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roast Logger</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body{margin:0;font-family:-apple-system;background:#fafafa}
#wrap{padding:10px}
#chartWrap{height:45vh}
button,input{width:100%;padding:12px;margin:6px 0;font-size:16px}
.row{display:flex;gap:6px}
.row>*{flex:1}
#dropBtn{background:#d32f2f;color:#fff;font-weight:bold}
#time{text-align:center;font-size:22px;margin:4px 0}
#history div{padding:8px;border-bottom:1px solid #ddd}
.smallBtn{font-size:12px;padding:4px}
small{color:#555}
</style>
</head>

<body>
<div id="wrap">
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="time">0:00</div>

  <button id="startBtn">ç„™ç…é–‹å§‹</button>

  <label>è±†æ¸© (â„ƒ)</label>
  <div class="row">
    <input id="tempInput" type="number" value="150">
    <button id="tempSet">æ±ºå®š</button>
  </div>

  <label>ã‚¬ã‚¹åœ§ (<span id="gasLabel">2.5</span>)</label>
  <input id="gasInput" type="range" min="0" max="5" step="0.5" value="2.5">

  <button id="dryBtn">Dry Endï¼ˆé•·æŠ¼ã—ï¼‰</button>
  <button id="fcBtn">1ãƒã‚¼ï¼ˆé•·æŠ¼ã—ï¼‰</button>
  <button id="dropBtn">DROP</button>

  <h3>å±¥æ­´</h3>
  <div id="history"></div>
</div>

<script>
/* ===== çŠ¶æ…‹ ===== */
const KEY="roastHistory";
let startTime=null,endTime=null,timer=null;
let temp=150,gas=2.5;
let dryEnd=null,fc=null;

let tempData=[], gasData=[];

/* ===== util ===== */
const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;
const nowSec=()=> endTime ?? Math.floor((Date.now()-startTime)/1000);

/* ===== ãƒ•ã‚§ãƒ¼ã‚ºè¨ˆç®— ===== */
function phaseSummary(){
  if(!endTime||dryEnd==null||fc==null) return null;
  const total=endTime;
  const d0=dryEnd;
  const d1=fc-dryEnd;
  const d2=endTime-fc;
  const pct=v=>Math.round(v/total*100);
  return {
    drying:{t:d0,p:pct(d0)},
    maillard:{t:d1,p:pct(d1)},
    dev:{t:d2,p:pct(d2)}
  };
}

/* ===== Chart ===== */
const chart=new Chart(chartElem,{
  type:"line",
  data:{
    datasets:[
      {label:"Temp",data:[],borderWidth:2},
      {label:"Gas",data:[],yAxisID:"yR",borderDash:[4,4]}
    ]
  },
  options:{
    animation:false,
    scales:{
      x:{type:"linear",min:0},
      y:{min:0,max:260},
      yR:{position:"right",min:0,max:5,grid:{drawOnChartArea:false}}
    }
  }
});

/* ===== æç”» ===== */
function draw(){
  const t=nowSec();
  time.textContent=fmt(t);
  chart.options.scales.x.max=Math.max(600,t+10);
  chart.data.datasets[0].data=tempData;
  chart.data.datasets[1].data=gasData;
  chart.update();
}

/* ===== é–‹å§‹ ===== */
startBtn.onclick=()=>{
  startTime=Date.now();
  endTime=null;
  dryEnd=fc=null;
  tempData=[{x:0,y:temp}];
  gasData=[{x:0,y:gas}];
  clearInterval(timer);
  timer=setInterval(draw,1000);
  draw();
};

/* ===== å…¥åŠ› ===== */
tempSet.onclick=()=>{
  temp=parseInt(tempInput.value);
  tempData.push({x:nowSec(),y:temp});
  draw();
};
gasInput.oninput=()=>{
  gas=parseFloat(gasInput.value);
  gasLabel.textContent=gas.toFixed(1);
  gasData.push({x:nowSec(),y:gas});
  draw();
};

/* ===== é•·æŠ¼ã— ===== */
let hold=null;
const startHold=fn=>hold=setTimeout(fn,600);
const cancelHold=()=>clearTimeout(hold);

dryBtn.onpointerdown=e=>{e.preventDefault();startHold(()=>dryEnd=nowSec());};
fcBtn.onpointerdown=e=>{e.preventDefault();startHold(()=>fc=nowSec());};
[dryBtn,fcBtn].forEach(b=>{
  b.onpointerup=cancelHold;
  b.onpointercancel=cancelHold;
});

/* ===== DROP & å±¥æ­´ ===== */
dropBtn.onclick=()=>{
  if(!startTime||endTime) return;
  endTime=nowSec();
  clearInterval(timer);
  saveHistory();
  draw();
};

/* ===== å±¥æ­´ ===== */
function loadHistory(){
  return JSON.parse(localStorage.getItem(KEY)||"[]");
}
function saveHistory(){
  const p=phaseSummary();
  const h=loadHistory();
  h.unshift({
    id:Date.now(),
    name:"",
    date:new Date().toLocaleString(),
    dryEnd,fc,end:endTime,
    phases:p,
    tempData,gasData
  });
  localStorage.setItem(KEY,JSON.stringify(h));
  renderHistory();
}
function renderHistory(){
  const h=loadHistory();
  history.innerHTML=h.length?h.map((r,i)=>`
    <div>
      <b onclick="replay(${i})">${r.name||"ï¼ˆåç§°æœªè¨­å®šï¼‰"}</b><br>
      <small>${r.date}</small><br>
      ${r.phases?`
      <small>
        DRY ${fmt(r.phases.drying.t)} (${r.phases.drying.p}%) /
        MAIL ${fmt(r.phases.maillard.t)} (${r.phases.maillard.p}%) /
        DEV ${fmt(r.phases.dev.t)} (${r.phases.dev.p}%)
      </small>`:""}
      <div class="row">
        <button class="smallBtn" onclick="edit(${i})">âœï¸</button>
        <button class="smallBtn" onclick="del(${i})">ğŸ—‘</button>
      </div>
    </div>
  `).join(""):"å±¥æ­´ãªã—";
}
function edit(i){
  const h=loadHistory();
  const n=prompt("ç„™ç…å",h[i].name||"");
  if(n!==null){
    h[i].name=n;
    localStorage.setItem(KEY,JSON.stringify(h));
    renderHistory();
  }
}
function del(i){
  if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    const h=loadHistory();
    h.splice(i,1);
    localStorage.setItem(KEY,JSON.stringify(h));
    renderHistory();
  }
}
function replay(i){
  const r=loadHistory()[i];
  clearInterval(timer);
  startTime=Date.now()-r.end*1000;
  endTime=r.end;
  dryEnd=r.dryEnd;
  fc=r.fc;
  tempData=r.tempData;
  gasData=r.gasData;
  draw();
}

renderHistory();
</script>
</body>
</html>
