<script>
/* ===== 状態 ===== */
let startTime=null,timer=null;
let times=[],temps=[];
let temp=150;
let dryEnd=null,fc=null,drop=null;

/* ===== util ===== */
const sec=()=>startTime?Math.floor((Date.now()-startTime)/1000):0;
const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;

/* ===== 時間軸（破壊しない） ===== */
function ensureRange(){
  const t=sec();
  const target=t>600?900:600;
  while(times.length-1<target){
    times.push(times.length);
    temps.push(null);
  }
}

/* ===== フェーズ ===== */
function phaseInfo(name,color,start,dur,showPct){
  const e=Math.max(0,sec()-start);
  const pct=showPct&&dur>0?Math.round(e/dur*100):null;
  return {name,color,elapsed:e,pct};
}
function currentPhase(){
  const t=sec();
  if(fc&&t>=fc){
    return phaseInfo(
      "DEVELOPMENT","#e53935",
      fc,
      drop?drop-fc:0,
      drop!=null
    );
  }
  if(dryEnd&&t>=dryEnd){
    return phaseInfo(
      "MAILLARD","#fb8c00",
      dryEnd,
      fc?fc-dryEnd:t-dryEnd,
      true
    );
  }
  if(startTime){
    return phaseInfo(
      "DRYING","#fbc02d",
      0,
      dryEnd?dryEnd:t,
      true
    );
  }
  return null;
}

/* ===== 背景 ===== */
function bg(s,e,color){
  if(s==null) return null;
  const end = e ?? (times.length - 1);
  const d = Array(times.length).fill(null);
  for(let i=s;i<=end && i<d.length;i++) d[i]=300;
  return {
    label:"",
    data:d,
    fill:true,
    backgroundColor:color,
    borderWidth:0,
    pointRadius:0,
    hidden:true
  };
}
function line(t,color,label){
  if(t==null) return null;
  const d=Array(times.length).fill(null);
  if(t<d.length) d[t]=300;
  return {label,data:d,borderColor:color,pointRadius:0};
}
</script>
