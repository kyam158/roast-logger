<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Roast Logger 完成版</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body {
  margin: auto;
  max-width: 420px;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
}
h2,h3 { text-align:center }

#timer {
  font-size: 48px;
  font-weight: bold;
  text-align: center;
}

canvas {
  width: 100% !important;
  height: 240px !important;
}

button {
  width: 100%;
  padding: 16px;
  margin: 6px 0;
  font-size: 20px;
  border-radius: 14px;
  touch-action: manipulation;
}

input {
  width: 100%;
  font-size: 26px;
  padding: 10px;
  text-align: center;
}

.temp-row, .phase-row {
  display: flex;
  gap: 8px;
}
.temp-row button { flex:1; font-size:32px }
.phase-row button { flex:1 }

.drop-btn {
  background:#d32f2f;
  color:#fff;
  font-size:26px;
}

.history {
  border-top:1px solid #ccc;
  margin-top:16px;
  padding-top:8px;
  font-size:14px;
}
.history div {
  padding:8px;
  border-bottom:1px solid #eee;
}
</style>
</head>

<body>

<h2>☕ Roast Logger</h2>

投入温度
<input id="chargeTemp" type="number" value="200">

初期ガス
<input id="chargeGas" type="number" step="0.1" value="0.5">

<button id="startBtn">焙煎スタート</button>

<div id="timer">0:00</div>

<canvas id="chart"></canvas>

<h3>温度</h3>
<input id="tempInput" value="200">

<div class="temp-row">
  <button id="tempMinus">−</button>
  <button id="tempPlus">＋</button>
</div>

<button id="addTemp">温度追加</button>

<h3>ガス</h3>
<div class="temp-row">
  <button id="gasMinus">−</button>
  <button id="gasDisp">0.5</button>
  <button id="gasPlus">＋</button>
</div>

<button id="gasRecord">ガス記録</button>

<h3>フェーズ</h3>
<div class="phase-row">
  <button id="dryBtn">Dry End（長押し）</button>
  <button id="fcBtn">1ハゼ（長押し）</button>
</div>

<button class="drop-btn" id="dropBtn">DROP</button>

<div id="phaseInfo">フェーズ未確定</div>

<h3>焙煎履歴</h3>
<div id="history" class="history"></div>

<script>
/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const startBtn=$("startBtn"), chargeTemp=$("chargeTemp"), chargeGas=$("chargeGas");
const tempInput=$("tempInput"), gasDisp=$("gasDisp"), timer=$("timer");
const phaseInfo=$("phaseInfo"), chartCtx=$("chart"), historyDiv=$("history");
const tempMinus=$("tempMinus"), tempPlus=$("tempPlus"), addTempBtn=$("addTemp");
const gasMinus=$("gasMinus"), gasPlus=$("gasPlus"), gasRecord=$("gasRecord");
const dryBtn=$("dryBtn"), fcBtn=$("fcBtn"), dropBtn=$("dropBtn");

/* ===== 状態 ===== */
let startTime, timerInt;
let times=[], temps=[], gasLog=[];
let temp=200, gas=0.5;
let dryEnd=null, fc=null, drop=null;
let chart, holdTimer;

/* ===== util ===== */
const sec=()=>Math.floor((Date.now()-startTime)/1000);
const fmt=s=>Math.floor(s/60)+":"+String(s%60).padStart(2,"0");

/* ===== 焙煎開始 ===== */
function startRoast(){
  startTime=Date.now();
  times=[0]; temps=[Number(chargeTemp.value)];
  temp=temps[0]; gas=Number(chargeGas.value);
  gasLog=[{time:0,gas}];
  gasDisp.textContent=gas.toFixed(1);
  dryEnd=fc=drop=null;
  clearInterval(timerInt);
  timer.textContent="0:00";
  timerInt=setInterval(()=>timer.textContent=fmt(sec()),1000);
  drawChart();
}
startBtn.onclick=startRoast;

/* ===== 温度 ===== */
tempInput.oninput=e=>temp=Number(e.target.value);
tempMinus.onclick=()=>{temp--;tempInput.value=temp};
tempPlus.onclick=()=>{temp++;tempInput.value=temp};
addTempBtn.onclick=()=>{times.push(sec());temps.push(temp);drawChart()};

/* ===== ガス ===== */
gasMinus.onclick=()=>{gas=Math.max(0,Math.round((gas-0.1)*10)/10);gasDisp.textContent=gas.toFixed(1)};
gasPlus.onclick=()=>{gas=Math.round((gas+0.1)*10)/10;gasDisp.textContent=gas.toFixed(1)};
gasRecord.onclick=()=>{gasLog.push({time:sec(),gas});drawChart()};

/* ===== フェーズ ===== */
function hold(type){
  holdTimer=setTimeout(()=>{
    if(type==="dry") dryEnd=sec();
    if(type==="fc") fc=sec();
    updatePhase(); drawChart();
  },1500);
}
const cancel=()=>clearTimeout(holdTimer);
dryBtn.onpointerdown=e=>{e.preventDefault();hold("dry")};
dryBtn.onpointerup=cancel;
fcBtn.onpointerdown=e=>{e.preventDefault();hold("fc")};
fcBtn.onpointerup=cancel;

/* ===== DROP & 保存 ===== */
dropBtn.onclick=()=>{
  drop=sec(); clearInterval(timerInt);
  saveHistory();
  updatePhase(); drawChart(); loadHistory();
};

/* ===== 履歴保存 ===== */
function saveHistory(){
  const list=JSON.parse(localStorage.getItem("roastHistory")||"[]");
  list.unshift({
    id:Date.now(),
    date:new Date().toLocaleString(),
    chargeTemp:Number(chargeTemp.value),
    dryEnd,fc,drop,
    times,temps,gasLog
  });
  localStorage.setItem("roastHistory",JSON.stringify(list.slice(0,20)));
}

/* ===== 履歴表示 ===== */
function loadHistory(){
  historyDiv.innerHTML="";
  const list=JSON.parse(localStorage.getItem("roastHistory")||"[]");
  list.forEach(r=>{
    const d=document.createElement("div");
    d.textContent=`${r.date} / ${fmt(r.drop)} / Dev ${Math.round((r.drop-r.fc)/r.drop*100)}%`;
    historyDiv.appendChild(d);
  });
}
loadHistory();

/* ===== 表示 ===== */
function updatePhase(){
  if(!dryEnd||!fc||!drop){phaseInfo.textContent="フェーズ未確定";return}
  phaseInfo.innerHTML=
`Dry ${fmt(dryEnd)}<br>
Mai ${fmt(fc-dryEnd)}<br>
Dev ${fmt(drop-fc)}<hr>
${Math.round(dryEnd/drop*100)} /
${Math.round((fc-dryEnd)/drop*100)} /
${Math.round((drop-fc)/drop*100)}%`;
}

/* ===== グラフ ===== */
function gasSeries(){
  let g=null,i=0;
  return times.map(t=>{
    while(i<gasLog.length&&gasLog[i].time<=t)g=gasLog[i++].gas;
    return g;
  });
}
function drawChart(){
  const labels=times.map(fmt);
  if(!chart) chart=new Chart(chartCtx,{type:"line",data:{labels,datasets:[]}});
  chart.data.labels=labels;
  chart.data.datasets=[
    {label:"Temp",data:temps},
    {label:"Gas",data:gasSeries(),stepped:true}
  ];
  chart.update();
}
</script>

</body>
</html>