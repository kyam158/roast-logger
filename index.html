<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Roast Logger</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#fafafa;
}
#wrap{padding:10px}
#chartWrap{height:45vh}
button,input{
  width:100%;
  padding:12px;
  margin:6px 0;
  font-size:16px;
}
.row{display:flex;gap:6px}
.row>*{flex:1}
</style>
</head>

<body>
<div id="wrap">

<div id="chartWrap"><canvas id="chart"></canvas></div>

<button id="startBtn">焙煎開始</button>

<div class="row">
  <input id="tempInput" type="number" value="150">
  <button id="tempSet">温度決定</button>
</div>

<label>ガス圧 (<span id="gasLabel">2.5</span>)</label>
<input id="gasInput" type="range" min="0" max="5" step="0.5" value="2.5">

</div>

<script>
let startTime=null;
let temp=150, gas=2.5;
let temps=[], gases=[], rors=[];
let timer=null;

const sec=()=>startTime?Math.floor((Date.now()-startTime)/1000):0;
const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;

const chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{datasets:[]},
  options:{
    animation:false,
    scales:{
      x:{
        type:"linear",
        min:0,
        max:600,
        ticks:{stepSize:60, callback:v=>fmt(v)}
      },
      y:{min:0,max:260},
      yR:{position:"right",min:-10,max:10,grid:{drawOnChartArea:false}}
    }
  }
});

function calcRoR(){
  rors=[];
  for(let i=30;i<temps.length;i++){
    if(temps[i]!=null && temps[i-30]!=null){
      rors.push({x:i,y:(temps[i]-temps[i-30])*2});
    }
  }
}

function draw(){
  const t=sec();
  chart.options.scales.x.max = t>600 ? 900 : 600;

  chart.data.datasets=[
    {
      label:"Temp",
      data:temps.map((v,i)=>v!=null?{x:i,y:v}:null),
      borderWidth:2
    },
    {
      label:"RoR",
      data:rors,
      borderColor:"#7b1fa2",
      yAxisID:"yR"
    },
    {
      label:"Gas",
      data:gases.map((v,i)=>v!=null?{x:i,y:v}:null),
      borderColor:"#1976d2",
      borderDash:[4,4],
      yAxisID:"yR"
    }
  ];
  chart.update();
}

startBtn.onclick=()=>{
  startTime=Date.now();
  temps=[];
  gases=[];
  rors=[];
  temps[0]=temp;
  gases[0]=gas;
  clearInterval(timer);
  timer=setInterval(draw,1000);
};

tempSet.onclick=()=>{
  temp=parseInt(tempInput.value);
  temps[sec()]=temp;
  calcRoR();
  draw();
};

gasInput.oninput=()=>{
  gas=parseFloat(gasInput.value);
  gasLabel.textContent=gas.toFixed(1);
  gases[sec()]=gas;
  draw();
};
</script>
</body>
</html>
