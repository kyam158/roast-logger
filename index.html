<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Roast Logger</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#fafafa;
  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
}
button{
  width:100%;
  padding:12px;
  margin:6px 0;
  font-size:16px;
  touch-action:manipulation;
}
#wrap{padding:10px}
#chartWrap{height:45vh}
</style>
</head>

<body>
<div id="wrap">

<div id="chartWrap">
<canvas id="chart"></canvas>
</div>

<button id="startBtn">焙煎開始</button>
<button id="dryBtn">Dry End（長押し）</button>
<button id="fcBtn">1ハゼ（長押し）</button>

</div>

<script>
/* ===== 状態 ===== */
let startTime=null,timer=null;
let times=[],temps=[];
let temp=150;
let dryEnd=null,fc=null,drop=null;

/* ===== util ===== */
const sec=()=>startTime?Math.floor((Date.now()-startTime)/1000):0;
const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;

/* ===== 時間軸 ===== */
function ensureRange(){
  const t=sec();
  const target = t>600 ? 900 : 600;
  if(times.length-1===target) return;
  times = Array.from({length:target+1},(_,i)=>i);
  temps.length=target+1;
}

/* ===== フェーズ ===== */
function phaseInfo(name,color,start,dur,showPct){
  const e=Math.max(0,sec()-start);
  const pct = showPct && dur>0 ? Math.round(e/dur*100) : null;
  return {name,color,elapsed:e,pct};
}
function currentPhase(){
  const t=sec();
  if(fc&&t>=fc){
    return phaseInfo("DEVELOPMENT","#e53935",fc,drop?drop-fc:0,false);
  }
  if(dryEnd&&t>=dryEnd){
    return phaseInfo("MAILLARD","#fb8c00",dryEnd,fc?fc-dryEnd:t-dryEnd,true);
  }
  if(startTime){
    return phaseInfo("DRYING","#fbc02d",0,dryEnd?dryEnd:t,true);
  }
  return null;
}

/* ===== フェーズ表示 ===== */
const phaseLabelPlugin={
  id:"phaseLabel",
  afterDraw(chart){
    const p=currentPhase();
    if(!p) return;
    const {ctx,chartArea}=chart;
    ctx.save();
    ctx.fillStyle=p.color;
    ctx.font="bold 14px sans-serif";
    ctx.fillText(p.name,chartArea.left+6,chartArea.top+6);
    ctx.font="12px sans-serif";
    ctx.fillStyle="#555";
    ctx.fillText(
      p.pct==null ? fmt(p.elapsed) : `${fmt(p.elapsed)} (${p.pct}%)`,
      chartArea.left+6,chartArea.top+24
    );
    ctx.restore();
  }
};

/* ===== 背景 ===== */
function bg(s,e,color){
  if(s==null||e==null) return null;
  const d=Array(times.length).fill(null);
  for(let i=s;i<=e&&i<d.length;i++) d[i]=300;
  return {
    label:"",
    data:d,
    fill:true,
    backgroundColor:color,
    borderWidth:0,
    pointRadius:0,
    hidden:true
  };
}
function line(t,color,label){
  if(t==null) return null;
  const d=Array(times.length).fill(null);
  if(t<d.length) d[t]=300;
  return {
    label,
    data:d,
    borderColor:color,
    pointRadius:0
  };
}

/* ===== Chart ===== */
const chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{labels:[],datasets:[]},
  options:{
    animation:false,
    plugins:{legend:{labels:{filter:l=>l.text}}},
    scales:{y:{min:0,max:260}}
  },
  plugins:[phaseLabelPlugin]
});

/* ===== 描画 ===== */
function draw(){
  ensureRange();
  chart.data.labels=times.map(fmt);
  chart.data.datasets=[
    bg(0,dryEnd,"rgba(255,235,59,.25)"),
    bg(dryEnd,fc,"rgba(255,152,0,.22)"),
    bg(fc,drop,"rgba(244,67,54,.22)"),
    {label:"Temp",data:temps,borderWidth:2},
    line(dryEnd,"#fbc02d","Dry"),
    line(fc,"#e64a19","1C")
  ].filter(Boolean);
  chart.update();
}

/* ===== 焙煎開始 ===== */
startBtn.onclick=()=>{
  startTime=Date.now();
  dryEnd=fc=drop=null;
  times=Array.from({length:601},(_,i)=>i);
  temps=Array(601).fill(null);
  temps[0]=temp;
  clearInterval(timer);
  timer=setInterval(draw,1000);
  draw();
};

/* ===== 長押し ===== */
let hold=null;
function startHold(fn){
  hold=setTimeout(fn,600);
}
function cancelHold(){
  clearTimeout(hold);
}
dryBtn.onpointerdown=e=>{e.preventDefault();startHold(()=>{dryEnd=sec();draw();});};
fcBtn.onpointerdown=e=>{e.preventDefault();startHold(()=>{fc=sec();draw();});};
[dryBtn,fcBtn].forEach(b=>{
  b.onpointerup=cancelHold;
  b.onpointercancel=cancelHold;
});
</script>
</body>
</html>
